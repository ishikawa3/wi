# Phase 5E: WI ヒートマップ表示 - 動作確認手順

## 起動方法

### 1. バックエンド API サーバー起動

```bash
cd /Users/ishikawa/Dev/wi/backend
source venv/bin/activate
uvicorn src.wi.api.main:app --reload --port 8000
```

**確認:**

- ターミナルに "Application startup complete" と表示される
- http://localhost:8000/docs でAPI ドキュメントが開ける

### 2. フロントエンド開発サーバー起動

```bash
cd /Users/ishikawa/Dev/wi/frontend
npm run dev
```

**確認:**

- ターミナルに "Local: http://localhost:5173/" と表示される
- エラーやワーニングがないこと

## ブラウザでの動作確認

### 基本動作

1. **ブラウザで http://localhost:5173 を開く**
   - ページが読み込まれる
   - ヘッダーに "Walkability Index" タイトルが表示される
   - 左サイドバーに「データ選択」セクションが表示される
   - 右側に地図エリア（グレー背景）が表示される

2. **エリアとプロファイルを選択**
   - エリアドロップダウンから "test" を選択
   - プロファイルドロップダウンから任意のプロファイル（例: "residential_family"）を選択
   - 「データ読み込み中...」メッセージが一瞬表示される

3. **ヒートマップ表示確認**
   - 地図上（東京駅周辺）に色付きのグリッドセル（25個）が表示される
   - セルの色が WI スコアに応じて変化する:
     - 🟢 緑色（80-100）: 高スコア
     - 🟡 黄緑～黄色（40-80）: 中スコア
     - 🔴 オレンジ～赤（0-40）: 低スコア

### ヒートマップ機能

4. **セルのホバー効果**
   - マウスをセルの上に移動
   - セルの境界線が太く、色が濃くなる（ハイライト）

5. **ポップアップ表示**
   - セルをクリック
   - ポップアップが表示され、以下の情報を確認:
     - **WI Score**: 大きく表示（例: "77.2"）
     - **Grid ID**: グリッドID（例: "test_00000_00000"）
     - **Amenity Scores**: アメニティ別スコア
       - 各アメニティ名とパーセンテージ
       - 青色のプログレスバーで視覚的に表示
       - スコアの高い順にソート

6. **レジェンド表示**
   - 左サイドバーの「凡例」セクションを確認
   - WI スコア範囲と色が対応している:
     - 80-100: 濃い緑
     - 60-80: 黄緑
     - 40-60: 黄色
     - 20-40: オレンジ
     - 0-20: 赤

7. **統計情報表示**
   - 左サイドバーの「統計」セクションを確認
   - **ビジュアルスコアレンジ**:
     - カラーグラデーションバー（赤→黄→緑）
     - 平均スコア位置に黒い縦線
     - 最小値・最大値ラベル
   - **詳細統計**:
     - 平均: 72.3（色付き）
     - 最小値: 59.8
     - 最大値: 87.3
     - 標準偏差: 8.6
     - 中央値: 69.4（色付き）
     - セル数: 25

### プロファイル切替

8. **プロファイル変更時のスムーズ更新**
   - プロファイルドロップダウンから別のプロファイルを選択
   - 「データ読み込み中...」表示
   - ヒートマップが自動的に更新される
   - 統計情報も更新される
   - 切替がスムーズ（< 1秒）

### 地図操作

9. **地図ズーム・パン**
   - マウスホイールでズームイン/ズームアウト
   - 地図をドラッグして移動
   - セルが地図と一緒に移動する

10. **OpenStreetMap タイル**
    - 背景地図（道路、建物等）が表示される
    - ズーム時にタイルが読み込まれる

## 期待される動作

### ✅ 正常動作の確認ポイント

1. **データ読み込み**
   - エリア・プロファイル選択後、即座にデータが表示される
   - ロード時間 < 2秒

2. **ヒートマップ描画**
   - 25個のグリッドセルが正しく配置される
   - 色分けが WI スコアに対応している
   - セル境界が明確

3. **インタラクション**
   - ホバー時のハイライト効果
   - クリック時のポップアップ表示
   - ポップアップ内のアメニティスコアが正しく表示される

4. **統計情報**
   - 統計値が計算されている
   - ビジュアルレンジ表示が機能する
   - 平均・中央値の色が WI スコアに応じて変化する

5. **プロファイル切替**
   - 切替時にデータが再読み込みされる
   - 古いデータが残らない
   - React Query キャッシュが機能する

## トラブルシューティング

### 地図が表示されない

- ブラウザの開発者ツール（F12）を開く
- Console タブでエラーを確認
- Leaflet CSS が正しく読み込まれているか確認

### セルが表示されない

- Network タブで `/api/v1/wi/grid` リクエストを確認
- レスポンスに `features` 配列が含まれているか確認
- バックエンド API が起動しているか確認

### プロキシエラー

- `vite.config.js` のプロキシ設定を確認
- バックエンドが http://localhost:8000 で起動しているか確認

### データが更新されない

- React DevTools でコンポーネントの再レンダリングを確認
- React Query のキャッシュをクリア（ブラウザリフレッシュ）

## 実装済み機能

### Phase 5E で実装された機能

✅ **WI Grid データ取得**

- React Query による自動データフェッチ
- area + profile 変更時の自動再取得
- キャッシング（5分間）

✅ **GeoJSON ヒートマップ表示**

- Leaflet GeoJSON レイヤー
- key prop によるデータ更新時の再レンダリング
- OpenStreetMap 背景タイル

✅ **WI スコア色分け**

- 5段階カラースケール（red → green）
- `getWIColorWithOpacity()` 関数
- fillOpacity: 0.6

✅ **レジェンド表示**

- カラースケールとラベル
- WI スコア範囲表示

✅ **統計情報表示**

- ビジュアルスコアレンジ（グラデーションバー + 平均インジケータ）
- 詳細統計（mean, min, max, std, median, count）
- スコア値の色付け

✅ **インタラクティブ機能**

- セルホバー時のハイライト
- セルクリック時のポップアップ
- アメニティスコア詳細表示（プログレスバー付き）

✅ **プロファイル切替**

- スムーズなデータ更新
- React Query による自動キャッシュ管理
- ローディング状態表示

## 次のステップ

Phase 5E が完了したら、次は **Phase 5F: 地点クリック・詳細表示** に進みます：

1. 地図上の任意の地点をクリック
2. `/api/v1/wi/point` エンドポイント呼び出し
3. 最寄りグリッドの WI 詳細を表示
4. より詳細なアメニティ分析（距離、種類等）
